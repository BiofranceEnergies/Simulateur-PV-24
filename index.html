<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulation Photovolta√Øque Simplifi√©e</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f4f8;
      margin: auto;
    }
    h1 {
      color: #2b7a0b;
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
    }
    .form-section,
    .recap,
    .result,
    #emailBloc {
      width: 100%;
      max-width: 600px;
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin: 0 auto 20px auto;
      box-sizing: border-box;
    }

    .recap,
    .result,
    #emailBloc {
      display: none;
      visibility: hidden;
      height: 0;
      overflow: hidden;
      padding: 0;
      margin: 0 auto;
      box-shadow: none;
      border: none;
    }

    .form-section h2,
    #emailBloc h2 {
      font-size: 18px;
      color: #123;
      margin-bottom: 20px;
    }

    .form-section input,
    .form-section button,
    #emailBloc input,
    #emailBloc button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 2px solid #007bff;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }

    .form-section button,
    #emailBloc button {
      background: #0069d9;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .form-section button:hover,
    #emailBloc button:hover {
      background: #0053ba;
    }

    .finance-details {
      font-size: 14px;
      color: #555;
      margin-top: 15px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #b3d4fc;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 20px;
        line-height: 1.4;
      }
      .form-section h2,
      #emailBloc h2 {
        font-size: 16px;
      }
      .finance-details {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <h1>En 3 secondes, d√©couvrez votre √©conomie et le chiffrage de votre projet solaire.</h1>

  <div class="form-section">
    <h2>Vos donn√©es de consommation</h2>
    <input type="text" id="codePostal" placeholder="Votre code postal" maxlength="5">
    <input type="number" id="conso" placeholder="Votre conso (kWh)">
    <input type="number" id="facture" placeholder="Votre facture (‚Ç¨)">
    <button onclick="calculerSimulation()">üîç Lancer la simulation</button>
  </div>

  <div id="loading" style="display: none; text-align: center; margin-top: 20px;">
    <div class="spinner"></div>
    <p style="font-size: 14px; color: #555;">Veuillez patienter... Calcul en cours</p>
  </div>

  <div id="recap" class="recap"></div>
  <div id="resultat" class="result"></div>

  


  <div id="emailBloc">
    <h2>üìß Recevez cette estimation compl√®te par email</h2>
    <p style="text-align:left; font-size: 15px; line-height: 1.6; color: #333;">
      Et si vous souhaitez un √©change pour affiner le projet selon <strong>votre toiture, vos besoins</strong> ou <strong>vos contraintes</strong>, vous pouvez aussi laisser votre num√©ro (facultatif).<br><br>
      <strong>‚ûï C‚Äôest rapide, sans engagement.</strong>
    </p>

    <input type="email" id="emailUser" placeholder="Votre adresse email">
    <input type="tel" id="telUser" placeholder="Votre num√©ro (pour √™tre rappel√© si vous le souhaitez)">
    <button onclick="envoyerEstimation()">üì© Recevoir mon estimation</button>

    <p style="margin-top: 20px; font-size: 14px; line-height: 1.4; text-align: center;">
      ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê <strong>4,9/5 sur Google</strong> ‚Äì Plus de 400 foyers accompagn√©s en France.<br>
      üîí Vos donn√©es ne seront jamais revendues. Aucun d√©marchage automatique.
    </p>
  </div>

  <script>
    let scenarios = [];

    function fetchScenarios(departement) {
      return fetch('https://script.google.com/macros/s/AKfycbwhlyD_FMMm2g9JIQAm2Se2xehUqIM2MzWMl1YGl_gP1DJKM_-jZFj_YStDMhWi-0F8XA/exec')
        .then(response => response.json())
        .then(data => data.filter(row => row.Departement == departement).map(row => ({
          puissance: row.Puissance,
          prod: parseFloat(row.Prod),
          seuil: parseFloat(row.Seuil),
          panels: parseInt(row.Panels),
          prix: parseFloat(row.Prix),
          mensualite: parseFloat(row.Mensualite),
          taeg: parseFloat(row.Taeg),
          total: parseFloat(row.Total)
        })))
        .catch(error => {
          console.error("Erreur lors du chargement des donn√©es :", error);
          alert("Impossible de charger les donn√©es, r√©essayez plus tard.");
          return [];
        });
    }

    async function calculerSimulation() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('recap').style.display = 'none';
      document.getElementById('resultat').style.display = 'none';
      document.getElementById('emailBloc').style.display = 'none';

      const codePostal = document.getElementById('codePostal').value.trim();
      const conso = parseFloat(document.getElementById('conso').value);
      const facture = parseFloat(document.getElementById('facture').value);

      if (!/^[0-9]{5}$/.test(codePostal)) {
        alert("Veuillez entrer un code postal valide.");
        return;
      }
      if (isNaN(conso) || isNaN(facture) || conso <= 0 || facture <= 0) {
        alert("Merci de remplir correctement tous les champs.");
        return;
      }

      const departement = codePostal.substring(0, 2);
      scenarios = await fetchScenarios(departement);

      if (scenarios.length === 0) {
        alert("Aucune donn√©e disponible pour ce d√©partement.");
        return;
      }

      document.getElementById('loading').style.display = 'none';

      const prixKwh = facture / conso;
      const scenario = [...scenarios].reverse().find(s => s.prod * 1.05 <= conso) || scenarios[0];
      scenarios.reverse();

      const autoKwh = scenario.prod * 0.6;
      const stockKwh = scenario.prod * 0.4;
      const acheminement = 0.05;

      const factureAvant = conso * prixKwh;
      const autoValue = autoKwh * prixKwh;
      const stockValue = stockKwh * prixKwh;
      const coutAcheminement = stockKwh * acheminement;
      const factureApres = factureAvant - autoValue - stockValue + coutAcheminement;
      const economieAnnuelle = factureAvant - factureApres;
      const economieMensuelle = economieAnnuelle / 12;

      let gain15ans = 0;
      let prixActuel = prixKwh;
      for (let i = 0; i < 15; i++) {
        const autoVal = autoKwh * prixActuel;
        const stockVal = stockKwh * prixActuel;
        const coutAch = stockKwh * acheminement;
        const factureAv = conso * prixActuel;
        const factureAp = factureAv - autoVal - stockVal + coutAch;
        const economie = factureAv - factureAp;
        gain15ans += economie;
        prixActuel *= 1.05;
      }

      const recapHTML = `
        Code postal : ${codePostal}<br>
        Consommation annuelle : ${conso.toLocaleString('fr-FR')} kWh<br>
        Prix du kWh : ${prixKwh.toFixed(3)} ‚Ç¨<br>
        Facture annuelle : ${facture.toLocaleString('fr-FR')} ‚Ç¨<br>
        Puissance install√©e : ${scenario.puissance} soit ${scenario.panels} panneaux photovolta√Øques de 500 W<br>
        Production annuelle : ${scenario.prod.toLocaleString('fr-FR')} kWh<br>
        <strong>Cela repr√©sente ${(scenario.prod / conso * 100).toFixed(2)}% de votre consommation annuelle.</strong>
      `;
      const recap = document.getElementById('recap');
      recap.innerHTML = recapHTML;
      recap.style.display = 'block';
      recap.style.visibility = 'visible';
      recap.style.height = 'auto';
      recap.style.padding = '20px';
      recap.style.margin = '0 auto 20px auto';
      recap.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
      recap.style.border = '1px solid #e0e0e0';

      const result = document.getElementById('resultat');
      result.innerHTML = `
        <div class="item"><strong>Gain estim√© la 1√®re ann√©e :</strong> ${economieAnnuelle.toFixed(0)} ‚Ç¨</div>
        <div class="item"><strong>Gain par mois :</strong> ${economieMensuelle.toFixed(0)} ‚Ç¨</div>
        <div class="item"><strong>√âconomie cumul√©e sur 15 ans :</strong> ${gain15ans.toFixed(0)} ‚Ç¨</div>
        <hr>
        <div class="item">
          <strong>üîÑ Ce que nous vous proposons</strong><br>
          üóñ Et si vous remplaciez votre facture d‚Äô√©lectricit√© par un investissement utile ?<br><br>
          üí° Chaque mois, au lieu de payer votre fournisseur, vous autofinancez votre propre installation solaire.<br><br>
          ‚ö° Une mensualit√© fixe de <strong>${scenario.mensualite.toFixed(2)} ‚Ç¨</strong>* pour financer cette installation cl√© en main ‚Äî et ainsi devenir propri√©taire de votre production solaire.<br><br>
          ‚úÖ Ce n‚Äôest pas une d√©pense en plus, c‚Äôest √† la place de ce que vous payez d√©j√†.<br><br>
          üéØ R√©sultat ? Vous devenez propri√©taire de votre production d‚Äô√©lectricit√©, tout en disant stop aux hausses de tarifs.
        </div>
        <div class="finance-details">
          * Exemple : installation ${scenario.puissance} √† ${scenario.prix.toLocaleString('fr-FR')} ‚Ç¨<br>
          financement sur 180 mois au TAEG fixe de ${scenario.taeg.toFixed(2)} %, mensualit√© ${scenario.mensualite.toFixed(2)} ‚Ç¨ (hors assurance).<br>
          Co√ªt total du financement hors assurance : ${scenario.total.toLocaleString('fr-FR')} ‚Ç¨.<br>
          Financement propos√© par notre partenaire Projexio, sous r√©serve d‚Äôacceptation. Un cr√©dit vous engage et doit √™tre rembours√©.<br>
          V√©rifiez vos capacit√©s de remboursement avant de vous engager.
        </div>
      `;
      result.style.display = 'block';
      result.style.visibility = 'visible';
      result.style.height = 'auto';
      result.style.padding = '20px';
      result.style.margin = '0 auto 20px auto';
      result.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
      result.style.border = '1px solid #e0e0e0';

      const emailBloc = document.getElementById('emailBloc');
      emailBloc.style.display = 'block';
      emailBloc.style.visibility = 'visible';
      emailBloc.style.height = 'auto';
      emailBloc.style.padding = '20px';
      emailBloc.style.margin = '0 auto 20px auto';
      emailBloc.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
      emailBloc.style.border = '1px solid #e0e0e0';
    }

function envoyerEstimation() {
  const codePostal = document.getElementById('codePostal').value.trim();
  const conso = parseFloat(document.getElementById('conso').value);
  const facture = parseFloat(document.getElementById('facture').value);
  const email = document.getElementById('emailUser').value.trim();
  const tel = document.getElementById('telUser').value.trim();

  if (!email) {
    alert("Merci de renseigner votre adresse email pour recevoir votre estimation.");
    return;
  }

  const scenario = scenarios[0];
  const prixKwh = facture / conso;
  const autoKwh = scenario.prod * 0.6;
  const stockKwh = scenario.prod * 0.4;
  const acheminement = 0.05;

  const factureAvant = conso * prixKwh;
  const autoValue = autoKwh * prixKwh;
  const stockValue = stockKwh * prixKwh;
  const coutAcheminement = stockKwh * acheminement;
  const factureApres = factureAvant - autoValue - stockValue + coutAcheminement;
  const economieAnnuelle = factureAvant - factureApres;
  const economieMensuelle = economieAnnuelle / 12;

  let gain15ans = 0;
  let prixActuel = prixKwh;
  for (let i = 0; i < 15; i++) {
    const autoVal = autoKwh * prixActuel;
    const stockVal = stockKwh * prixActuel;
    const coutAch = stockKwh * acheminement;
    const factureAv = conso * prixActuel;
    const factureAp = factureAv - autoVal - stockVal + coutAch;
    const economie = factureAv - factureAp;
    gain15ans += economie;
    prixActuel *= 1.05;
  }

  const payload = {
    code_postal: codePostal,
    conso: conso,
    facture: facture,
    prod: scenario.prod,
    eco1: economieAnnuelle.toFixed(0),
    ecomensuelle: economieMensuelle.toFixed(0),
    eco15: gain15ans.toFixed(0),
    puissance: scenario.puissance,
    panneaux: scenario.panels,
    prix: scenario.prix,
    mensualite: scenario.mensualite,
    taeg: scenario.taeg,
    totalcredit: scenario.total,
    email: email,
    tel: tel
  };

  fetch('https://script.google.com/macros/s/AKfycbwhlyD_FMMm2g9JIQAm2Se2xehUqIM2MzWMl1YGl_gP1DJKM_-jZFj_YStDMhWi-0F8XA/exec', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(response => response.text())
  .then(result => {
    if (result === "OK") {
      alert("‚úÖ Estimation bien envoy√©e ! Vous la recevrez tr√®s bient√¥t.");
    } else {
      alert("‚ùå Une erreur s‚Äôest produite : " + result);
    }
  })
  .catch(error => {
    console.error("Erreur d'envoi :", error);
    alert("Erreur d‚Äôenvoi. Veuillez r√©essayer.");
  });
}

  </script>
</body>
</html>

