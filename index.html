<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/BiofranceEnergies/biofrance-images/3b818ace228fca843d5b454ed6458b66900078d4/favicon%20Solution%20Solaire%20Pro.png">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulateur solaire gratuit ‚Äì Estimation panneaux photovolta√Øques Dordogne & France</title>
  <meta name="description" content="Simulateur solaire gratuit et imm√©diat pour estimer votre installation photovolta√Øque en Dordogne et partout en France. Chiffrage, √©tude personnalis√©e et devis sans inscription.">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-11242044118"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-11242044118');
  </script>
  <script>
    function gtag_report_conversion(url) {
      var callback = function () {
        if (typeof(url) != 'undefined') {
          window.location = url;
        }
      };
      gtag('event', 'conversion', {
          'send_to': 'AW-11242044118/Ij6sCPHtj_IaENb1z_Ap',
          'value': 1.0,
          'currency': 'EUR',
          'event_callback': callback
      });
      return false;
    }
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f4f8;
      margin: auto;
    }
    h1 {
      color: #178038;
      text-align: center;
      font-size: 30px;
      font-weight: 900;
      margin-bottom: 14px;
      line-height: 1.25;
    }
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 80%;
      height: auto;
    }
    .form-section,
    .recap,
    .result,
    #emailBloc,
    #temoignagesBloc {
      width: 100%;
      max-width: 600px;
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin: 0 auto 20px auto;
      box-sizing: border-box;
    }
    .recap,
    .result,
    #emailBloc {
      display: none;
      visibility: hidden;
      height: 0;
      overflow: hidden;
      padding: 0;
      margin: 0 auto;
      box-shadow: none;
      border: none;
    }
    .form-section h2,
    #emailBloc h2 {
      font-size: 20px;
      color: #145e39;
      font-weight: 700;
      margin-bottom: 14px;
    }
    .form-section input,
    .form-section button,
    #emailBloc input,
    #emailBloc button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 2px solid #007bff;
      border-radius: 8px;
      font-size: 18px;
      box-sizing: border-box;
    }
    .form-section button,
    #emailBloc button {
      background: #198754;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 19px;
      border-radius: 8px;
      font-weight: 700;
      margin-top: 5px;
    }
    .form-section button:hover,
    #emailBloc button:hover {
      background: #0053ba;
    }
    .finance-details {
      font-size: 14px;
      color: #555;
      margin-top: 15px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #b3d4fc;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .temoignages-titre {
      color: #198754;
      font-weight: bold;
      text-align: center;
      font-size: 2rem;
      margin-bottom: 18px;
      margin-top: 0;
    }
    #temoignagesBloc {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,128,0,0.07);
      border: 1px solid #e0e0e0;
      margin-top: 32px;
      padding: 26px 22px;
      display: none;
      visibility: hidden;
      height: 0;
      overflow: hidden;
    }
    .temoignage {
      margin-bottom: 22px;
      background: #f7f9f7;
      border-radius: 10px;
      padding: 16px 18px;
      border-left: 4px solid #2b7a0b;
    }
    .stars {
      color: #ffbe22;
      font-size: 1.2em;
      font-weight: bold;
    }
    .region {
      color: #1a8b4d;
      font-size: 1em;
      margin-left: 6px;
      font-style: italic;
    }
    #cookie-banner {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #222;
      color: #fff;
      font-size: 15px;
      line-height: 1.5;
      padding: 18px 12px 16px 12px;
      text-align: center;
      z-index: 9999;
      box-shadow: 0 -2px 12px rgba(0,0,0,0.09);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.25s;
    }
    #cookie-banner button {
      background: #198754;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 28px;
      margin-top: 10px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: background 0.18s;
    }
    #cookie-banner button:hover {
      background: #145e39;
    }
    #mentions-legales-container {
      width: 100%;
      text-align: center;
      margin-top: 32px;
      margin-bottom: 10px;
      display: none;
    }
    #mentions-legales-link {
      color: #2279b5;
      font-size: 15px;
      text-decoration: underline;
      cursor: pointer;
      background: transparent;
      padding: 2px 7px;
      border-radius: 7px;
      font-weight: 500;
      transition: color 0.18s, background 0.18s;
      display: inline-block;
    }
    #mentions-legales-link:hover {
      color: #145e39;
      background: #d3efe3;
    }
    #mentions-popup {
      display: none;
      position: fixed;
      bottom: 54px;
      left: 50%;
      transform: translateX(-50%);
      width: 320px;
      max-width: 95vw;
      background: #21282b;
      color: #f2f2f2;
      border-radius: 13px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.16);
      padding: 18px 22px 12px 22px;
      z-index: 10000;
      font-size: 13px;
      line-height: 1.7;
      border: 2px solid #5fffad;
      animation: popupfade 0.22s;
    }
    @keyframes popupfade {
      from {opacity:0;transform:translateY(30px);}
      to {opacity:1;transform:translateY(0);}
    }
    #mentions-popup strong {
      color: #5fffad;
      font-weight: bold;
      font-size: 14px;
    }
    #close-mentions {
      position: absolute;
      top: 7px;
      right: 14px;
      background: none;
      color: #f2f2f2;
      border: none;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
    }
    @media (max-width: 500px) {
      #mentions-popup {
        width: 92vw;
        left: 2vw;
        transform: none;
        bottom: 50px;
        padding: 12px 8px 10px 10px;
        font-size: 11px;
      }
      #mentions-legales-link {
        font-size: 13px;
      }
    }
  </style>
  <!-- Meta Pixel Code -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '4077327712591041');
    fbq('track', 'PageView');
    window.addEventListener("message", function(event) {
      if (event.data === "fbq-lead" && typeof fbq === "function") {
        fbq('track', 'Lead');
      }
    });
    document.addEventListener("DOMContentLoaded", function () {
      const boutonSimuler = document.getElementById("simuler");
      if (boutonSimuler) {
        boutonSimuler.addEventListener("click", function () {
          if (typeof fbq === "function") {
            fbq('trackCustom', 'SimulateurUtilise');
            console.log("‚úÖ fbq SimulateurUtilise envoy√©");
          }
        });
      }
      const params = new URLSearchParams(window.location.search);
      const source = params.get("from") || "direct";
      const userAgent = "SiteW";
      const img = document.createElement("img");
      img.src = `https://script.google.com/macros/s/AKfycbxt0po8cZNTMKGNBwqW-fEieOKib6HHJUGk6bXTQMgWv07GAJVSrFuJ5rf2qekTMaXfGw/exec?ua=${userAgent}&source=${source}`;
      img.style.display = "none";
      document.body.appendChild(img);
    });
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=4077327712591041&ev=PageView&noscript=1" />
  </noscript>
</head>
<body>
  <img src="https://raw.githubusercontent.com/BiofranceEnergies/biofrance-images/73ba9368d7b1da286c54b1f2c4ee3ce7dc2c7497/Logo%20biofrance%20energie%20-webp.webp" alt="Logo de l'entreprise" class="logo">

  <!-- Compteur dynamique -->
  <div style="text-align:center; margin-bottom:22px;">
    <div style="
      display:inline-block;
      background:#e6f3eb;
      border-radius:18px;
      box-shadow:0 4px 16px rgba(0,80,32,0.07);
      padding:14px 30px 12px 30px;
      min-width:180px;">
      <span id="compteurValeur" style="font-size:38px; color:#197c3e; font-weight:900; letter-spacing:2px; display:block; line-height:1.15;">1¬†234</span>
      <span style="color:#1a1a1a; font-size:16px; font-weight:700; display:block; margin-top:2px;">simulations r√©alis√©es depuis le 1er mai 2025</span>
    </div>
  </div>
  <!-- ACCROCHE + FORMULAIRE "BOOST√âS" -->
  <h1>
    Simulateur solaire gratuit&nbsp;: obtenez votre √©tude personnalis√©e en <span style="color:#e64c00;">3&nbsp;secondes</span>
  </h1>
  <h2 style="text-align:center; font-size:22px; color:#178038; margin-top:0;">
    Estimation photovolta√Øque pr√©cise ‚Äì Calcul des √©conomies, devis installation et autoconsommation en Dordogne & P√©rigord
  </h2>
  <div style="text-align: center; color: #1a1a1a; font-size: 18px; margin-bottom: 22px;">
    <span style="color:#198754; font-weight: bold;">Simple, gratuit, imm√©diat</span>¬†:  
    obtenez votre √©tude personnalis√©e et le co√ªt de votre installation photovolta√Øque.<br>
    <span style="color:#1a8b4d;">Aucune inscription, aucun engagement. R√©sultat imm√©diat.</span><br>
    <span style="display:inline-block; margin-top:7px; color:#007bff; font-size:15px;">
      <strong>Fiabilit√© 98&nbsp;% :</strong> estimation r√©alis√©e avec une IA, bas√©e sur vos donn√©es locales et les sc√©narios techniques les plus r√©cents.
    </span>
  </div>

  <!-- ----------- FORMULAIRE AVEC KWH OPTIONNEL ----------- -->
  <div class="form-section" style="background: #f9fff7; border:1px solid #c8f6dc;">
    <h2>üìä Simulation personnalis√©e</h2>
    <input type="text" id="codePostal" placeholder=" Votre code postal" maxlength="5" style="font-size:18px;">
    <input type="number" id="facture" placeholder=" Votre facture √©lec /an (‚Ç¨)" style="font-size:18px;">
    <div id="modeAvance" style="display:none;">
      <input type="number" id="conso" placeholder=" Conso annuelle (kWh, optionnel)" style="font-size:18px;">
    </div>
    <a href="#" id="lienAvance" style="font-size:15px; color:#168b4a; text-decoration:underline; display:block; margin-bottom:10px;">
      ‚ûï Vous connaissez votre consommation annuelle‚ÄØ? Cliquez ici pour une estimation ultra-pr√©cise
    </a>
    <button id="simuler" onclick="calculerSimulation()">
      üîç Obtenir mon estimation
    </button>
  </div>
  <!-- ----------- FIN FORMULAIRE ----------- -->

  <div id="loading" style="display: none; text-align: center; margin-top: 20px;">
    <div class="spinner"></div>
    <p style="font-size: 14px; color: #555;">Veuillez patienter... Calcul en cours</p>
  </div>
  <div id="recap" class="recap"></div>
  <div id="resultat" class="result"></div>
  <div id="emailBloc">
    <h2>üìß Recevez cette estimation compl√®te par email</h2>
    <p style="text-align:left; font-size: 15px; line-height: 1.6; color: #333;">
      Et si vous souhaitez un √©change pour affiner le projet selon <strong>votre toiture, vos besoins</strong> ou <strong>vos contraintes</strong>, vous pouvez aussi laisser votre num√©ro (facultatif).<br><br>
      <strong>‚ûï C‚Äôest rapide, sans engagement.</strong>
    </p>
    <input type="email" id="emailUser" placeholder="Votre adresse email">
    <input type="tel" id="telUser" placeholder="Votre num√©ro (Facultatif)">
    <button onclick="envoyerEstimation(); gtag_report_conversion();">üì© Recevoir mon estimation</button>

    <p style="margin-top: 20px; font-size: 14px; line-height: 1.4; text-align: center;">
      ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê <strong>4,5/5 sur Google</strong> ‚Äì Plus de 6400 foyers accompagn√©s en France.<br>
      üîí Vos donn√©es ne seront jamais revendues. Aucun d√©marchage automatique.
    </p>
    <p id="confirmationMessage" style="display: none; color: green; font-weight: bold; margin-top: 15px; text-align: center;">
      ‚úÖ Estimation bien envoy√©e ! Un email vient de vous √™tre adress√©.
    </p>
  </div>
  <div id="temoignagesBloc" style="display:none; visibility:hidden; height:0; overflow:hidden; padding:26px 22px; background:#fff; border-radius:14px; box-shadow:0 4px 12px rgba(0,128,0,0.07); border:1px solid #e0e0e0; margin-top:32px;">
    <div class="temoignages-titre">Ils l'ont test√©&nbsp;</div>
    <div class="temoignage">
      <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
      <br>
      ‚ÄúC‚Äôest la premi√®re fois que j‚Äôai une estimation aussi claire et transparente sans avoir √† laisser mes coordonn√©es partout. Bravo pour la d√©marche honn√™te !‚Äù
      <br>
      <span class="region">‚Äì Michel L., P√©rigueux</span>
    </div>
    <div class="temoignage">
      <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
      <br>
      ‚ÄúJ‚Äôai appr√©ci√© la rapidit√© du simulateur et le fait d‚Äôobtenir un chiffrage complet sans d√©marchage. Je recommande.‚Äù
      <br>
      <span class="region">‚Äì Sophie G., Sarlat</span>
    </div>
    <div class="temoignage">
      <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
      <br>
      ‚ÄúJ‚Äôai pu comparer facilement avant de me d√©cider, et Biofrance √ânergie m‚Äôa rappel√© quand j‚Äô√©tais pr√™t. Service s√©rieux, rien √† redire.‚Äù
      <br>
      <span class="region">‚Äì Paul D., Bergerac</span>
    </div>
    <div class="temoignage">
      <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
      <br>
      ‚ÄúC‚Äôest la premi√®re fois qu‚Äôon me donne autant d‚Äôinfos sans rien demander en retour. Contact tr√®s professionnel ensuite.‚Äù
      <br>
      <span class="region">‚Äì Claire F., Nontron</span>
    </div>
    <div class="temoignage">
      <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
      <br>
      ‚ÄúJ‚Äôai pu faire mon choix sans pression. Apr√®s avoir re√ßu l‚Äô√©tude, j‚Äôai contact√© Biofrance pour finaliser, je recommande sans h√©siter.‚Äù
      <br>
      <span class="region">‚Äì Jean-Pierre T., Terrasson</span>
    </div>
      <div style="font-size:14px; color:#444; margin: 38px auto 15px auto; max-width: 650px; line-height:1.6;">
  <h2 style="font-size:18px; color:#178038; font-weight:700; margin-bottom:10px;">Simulation panneaux solaires maison individuelle Dordogne et P√©rigord</h2>
  <p>
    Utilisez ce simulateur en ligne pour estimer gratuitement l‚Äôautoconsommation solaire de votre maison individuelle en Dordogne, P√©rigord ou Nouvelle-Aquitaine, y compris pour une toiture √† faible pente ou une maison ancienne.  
    <br><br>
    <strong>Options propos√©es :</strong>  
    ‚Äì Simulation gratuite autoconsommation solaire 24  
    ‚Äì Calcul √©conomie solaire sur facture Dordogne  
    ‚Äì Estimation production photovolta√Øque maison neuve ou ancienne  
    ‚Äì Simulateur rendement panneaux solaires et production r√©elle  
    ‚Äì Chiffrage imm√©diat du co√ªt d‚Äôinstallation en Dordogne
    <br><br>
    <em>Recevez une √©tude personnalis√©e sans inscription ni engagement, et comparez en direct la rentabilit√© solaire pour votre logement.</em>
  </p>
  <ul style="margin-top:6px; margin-bottom:0; font-size:13px;">
    <li>Simulateur panneaux solaires maison individuelle Dordogne</li>
    <li>Simulation gratuite autoconsommation solaire 24</li>
    <li>Estimation installation solaire P√©rigord</li>
    <li>Calcul √©conomie solaire sur facture Dordogne</li>
    <li>Simulateur production photovolta√Øque maison ancienne</li>
    <li>Simulateur solaire toiture faible pente Dordogne</li>
  </ul>
</div>

  </div>
  <div id="cookie-banner" style="display: none;">
    <span>
      Ce site utilise des cookies strictement n√©cessaires au fonctionnement du simulateur et √† la mesure d‚Äôaudience. 
      <br>En poursuivant votre navigation, vous acceptez leur utilisation. 
    </span>
    <button id="cookie-ok">OK, j‚Äôai compris</button>
  </div>
  <div id="mentions-legales-container">
    <span id="mentions-legales-link">Mentions l√©gales</span>
  </div>
  <div id="mentions-popup" style="display:none;">
    <button id="close-mentions" aria-label="Fermer">&times;</button>
    <strong>Mentions l√©gales :</strong><br>
    Conseils Energies Durables ‚Äì Matignon Sylvain<br>
    SIRET : 422 231 928 00025<br>
    Adresse : 4 rue du Pont Saint Jean, 27530 √âzy-sur-Eure<br>
    Contact : conseilsenergiesdurables@gmail.com<br>
    H√©bergeur : GitHub Pages, 88 Colin P. Kelly Jr. Street, San Francisco, CA 94107, USA<br>
    Donn√©es personnelles : Les informations saisies sont utilis√©es uniquement pour traiter votre demande. Aucun d√©marchage ni revente.<br>
    RGPD : Vous pouvez demander la suppression de vos donn√©es √† tout moment par simple email.
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Affichage champ kWh avanc√©
      var lienAvance = document.getElementById('lienAvance');
      if (lienAvance) {
        lienAvance.onclick = function(e) {
          e.preventDefault();
          document.getElementById('modeAvance').style.display = 'block';
          this.style.display = 'none';
        };
      }
      // Cookie
      if (!localStorage.getItem("cookieConsentPV2025")) {
        document.getElementById("cookie-banner").style.display = "flex";
      }
      document.getElementById("cookie-ok").onclick = function() {
        localStorage.setItem("cookieConsentPV2025", "1");
        document.getElementById("cookie-banner").style.display = "none";
      };
      var telInput = document.getElementById('telUser');
      if(telInput) {
        telInput.addEventListener('input', function(e) {
          let val = e.target.value.replace(/\D/g, '').slice(0, 10);
          let format = val.replace(/(\d{2})(?=\d)/g, '$1 ').trim();
          e.target.value = format;
        });
      }
    });
    let scenarios = [];
    function afficherLienMentionsLegales() {
      document.getElementById('mentions-legales-container').style.display = 'block';
    }
    function masquerLienMentionsLegales() {
      document.getElementById('mentions-legales-container').style.display = 'none';
      document.getElementById('mentions-popup').style.display = 'none';
    }
    document.getElementById('mentions-legales-link').onclick = function() {
      document.getElementById('mentions-popup').style.display = 'block';
    };
    document.getElementById('close-mentions').onclick = function() {
      document.getElementById('mentions-popup').style.display = 'none';
    };
    function fetchScenarios(departement) {
      return fetch('https://script.google.com/macros/s/AKfycbwhlyD_FMMm2g9JIQAm2Se2xehUqIM2MzWMl1YGl_gP1DJKM_-jZFj_YStDMhWi-0F8XA/exec')
        .then(response => response.json())
        .then(data => data.filter(row => row.Departement == departement).map(row => ({
          prixKwh: parseFloat((row.PrixKwh || '').toString().replace(',', '.').replace(/[^0-9.]/g, '')),
          puissance: row.Puissance,
          prod: parseFloat(row.Prod),
          seuil: parseFloat(row.Seuil),
          panels: parseInt(row.Panels),
          prix: parseFloat(row.Prix),
          mensualite: parseFloat(row.Mensualite),
          taeg: parseFloat(row.Taeg),
          total: parseFloat(row.Total)
        })))
        .catch(error => {
          console.error("Erreur lors du chargement des donn√©es :", error);
          alert("Impossible de charger les donn√©es, r√©essayez plus tard.");
          return [];
        });
    }

    // -------- CORRECTION ICI --------
    async function calculerSimulation() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('loading').scrollIntoView({ behavior: 'smooth', block: 'center' });
      document.getElementById('recap').style.display = 'none';
      document.getElementById('resultat').style.display = 'none';
      document.getElementById('emailBloc').style.display = 'none';
      document.getElementById('temoignagesBloc').style.display = 'none';
      document.getElementById('temoignagesBloc').style.visibility = 'hidden';
      document.getElementById('temoignagesBloc').style.height = '0';
      masquerLienMentionsLegales();
      const codePostal = document.getElementById('codePostal').value.trim();
      const facture = parseFloat(document.getElementById('facture').value);
      const consoInput = document.getElementById('conso');
      let conso, prixKwh;
      if (!/^[0-9]{5}$/.test(codePostal)) {
        alert("Veuillez entrer un code postal valide.");
        return;
      }
      if (isNaN(facture) || facture <= 0) {
        alert("Merci de remplir correctement tous les champs.");
        return;
      }
      const departement = codePostal.substring(0, 2);
      scenarios = await fetchScenarios(departement);
      if (scenarios.length === 0) {
        alert("Aucune donn√©e disponible pour ce d√©partement.");
        return;
      }
      document.getElementById('loading').style.display = 'none';

      // Calcul de la consommation estim√©e
      let consommationEstimee;
      if (consoInput && consoInput.value) {
        conso = parseFloat(consoInput.value);
        if (isNaN(conso) || conso <= 0) {
          alert("Merci d‚Äôindiquer une consommation kWh correcte.");
          return;
        }
        prixKwh = facture / conso;
        consommationEstimee = conso;
      } else {
        prixKwh = scenarios[0].prixKwh;
        consommationEstimee = facture / prixKwh;
        conso = consommationEstimee;
      }

      // V√©rifie si la conso < plus petite production disponible
      const minProd = Math.min(...scenarios.map(s => s.prod));
      if (consommationEstimee < minProd) {
        document.getElementById('recap').innerHTML = `
          <div style="color: #b30000; font-weight: bold; font-size: 19px; text-align: center;">
            <span style="font-size: 30px;">‚ö†Ô∏è</span><br>
            <span>Votre consommation annuelle d‚Äô√©lectricit√© est trop faible pour qu‚Äôune installation photovolta√Øque soit conseill√©e dans votre cas.</span><br><br>
            <span style="font-weight: normal; color: #1a1a1a; font-size: 15px;">
              Investir dans une installation surdimensionn√©e ne serait pas pertinent‚ÄØ: le montant √©conomis√© ne couvrirait pas le co√ªt de l‚Äôinstallation.<br><br>
              Nous privil√©gions la transparence‚ÄØ: <b>nous ne recommandons pas d‚Äôinstallation solaire pour votre profil</b>.<br><br>
              Si votre situation √©volue ou si vous souhaitez un conseil personnalis√©, contactez-nous, nous √©tudierons votre dossier avec attention.
            </span>
          </div>
        `;
        document.getElementById('recap').style = "display:block;visibility:visible;height:auto;padding:20px;margin:0 auto 20px auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);border:1px solid #e0e0e0;";
        document.getElementById('resultat').style.display = "none";
        document.getElementById('emailBloc').style.display = "none";
        document.getElementById('temoignagesBloc').style.display = "none";
        masquerLienMentionsLegales();
        return;
      }

      // -------- CORRECTION DE DIMENSIONNEMENT --------
      let scenario = scenarios
        .filter(s => s.prod <= consommationEstimee)
        .sort((a, b) => b.prod - a.prod)[0];
      if (!scenario) {
        // Si la conso est sup√©rieure √† toutes les productions, proposer la plus grosse installation dispo
        scenario = scenarios.sort((a, b) => b.prod - a.prod)[0];
      }
      window.selectedScenario = scenario;

      // --- Le reste de tes calculs ne bouge pas
      const autoKwh = scenario.prod * 0.6;
      const stockKwh = scenario.prod * 0.4;
      const acheminement = 0.05;
      const factureAvant = conso * prixKwh;
      const autoValue = autoKwh * prixKwh;
      const stockValue = stockKwh * prixKwh;
      const coutAcheminement = stockKwh * acheminement;
      const factureApres = factureAvant - autoValue - stockValue + coutAcheminement;
      const economieAnnuelle = factureAvant - factureApres;
      const economieMensuelle = economieAnnuelle / 12;
      let gain15ans = 0;
      let prixActuel = prixKwh;
      for (let i = 0; i < 15; i++) {
        const autoVal = autoKwh * prixActuel;
        const stockVal = stockKwh * prixActuel;
        const coutAch = stockKwh * acheminement;
        const factureAv = conso * prixActuel;
        const factureAp = factureAv - autoVal - stockVal + coutAch;
        const economie = factureAv - factureAp;
        gain15ans += economie;
        prixActuel *= 1.05;
      }
      document.getElementById('recap').innerHTML = `
        Code postal : ${codePostal}<br>
        Consommation annuelle estim√©e : <strong>${Math.round(conso).toLocaleString('fr-FR')}</strong> kWh<br>
        Prix du kWh TTC utilis√© : <strong>${prixKwh.toFixed(3)}</strong> ‚Ç¨<br>
        Facture annuelle : ${facture.toLocaleString('fr-FR')} ‚Ç¨<br><br>
        Puissance install√©e : ${scenario.puissance} soit ${scenario.panels} panneaux photovolta√Øques de 500 W<br><br>
        Production annuelle : <span style="color: #2b7a0b; font-weight: bold;">${scenario.prod.toLocaleString('fr-FR')}</span> kWh<br><br>
        <strong>Cela repr√©sente ${(scenario.prod / conso * 100).toFixed(2)}% de votre consommation annuelle.</strong><br>
        <span style="display:inline-block; margin-top:10px; color:#2b7a0b; font-size:15px; font-weight:bold;">
          Gr√¢ce √† la batterie virtuelle, vous consommez 100% de votre production !
        </span>
      `;
      document.getElementById('recap').style = "display:block;visibility:visible;height:auto;padding:20px;margin:0 auto 20px auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);border:1px solid #e0e0e0;";
      document.getElementById('resultat').innerHTML = `
        <div class="item"><strong>Gain estim√© la 1√®re ann√©e :</strong> <span style="color: #2b7a0b; font-weight: bold;">${Math.round(economieAnnuelle).toLocaleString('fr-FR')}</span> ‚Ç¨</div><br>
        <div class="item"><strong>Soit un gain par mois de :</strong> <span style="color: #2b7a0b; font-weight: bold;">${Math.round(economieMensuelle).toLocaleString('fr-FR')}</span> ‚Ç¨</div><br>
        <div class="item"><strong>√âconomie cumul√©e sur 15 ans :</strong> <span style="color: #2b7a0b; font-weight: bold;">${Math.round(gain15ans).toLocaleString('fr-FR')}</span> ‚Ç¨</div>
        <hr>
        <div class="item">
          <strong>üîÑ Ce que nous vous proposons</strong><br><br>
          üóñ Et si vous remplaciez votre facture d‚Äô√©lectricit√© par un investissement utile ?<br><br>
          üí° Chaque mois, au lieu de payer votre fournisseur, vous autofinancez votre propre installation solaire.<br><br>
          ‚ö° Une mensualit√© fixe de <strong>${scenario.mensualite.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨</strong>* pour financer cette installation cl√© en main ‚Äî et ainsi devenir propri√©taire de votre production solaire.<br><br>
          ‚úÖ Ce n‚Äôest pas une d√©pense en plus, c‚Äôest √† la place de ce que vous payez d√©j√†.<br><br>
          üéØ R√©sultat ? Vous devenez propri√©taire de votre production d‚Äô√©lectricit√©, tout en disant stop aux hausses de tarifs.
      <div style="background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,128,0,0.06); border: 1px solid #198754; font-size: 15px; color: #175837; font-weight: normal; text-align: center; margin: 22px 0 18px 0; padding: 16px 14px 10px 14px;">
        <strong>Pour information&nbsp;:</strong><br>
        Offre financement exceptionnel&nbsp;:<br>
        <span style="color: #13723a; font-size: 20px; font-weight: bold;">TAEG fixe 3,96‚ÄØ% sur 180 mois</span>
        <br>
        <span style="color: #e64c00; font-size: 13px; font-weight: 600;">Valable pour toute √©tude r√©alis√©e avant le <u>31 juillet 2025</u></span>
      </div>
        <div style="background:#f7f9f7; border-left:4px solid #198754; border-radius:12px; padding:14px 18px 12px 14px; margin-top:22px; font-size:16px; color:#222;">
          <span style="display:inline-block; vertical-align:middle; margin-right:8px;">
            <svg width="26" height="26" style="vertical-align:middle;" viewBox="0 0 24 24" fill="#8dc2a7"><circle cx="12" cy="12" r="12"/><text x="7" y="18" font-size="14" font-weight="bold" fill="#fff">i</text></svg>
          </span>
          <span>
            * Votre installation ${scenario.puissance} : ${scenario.prix.toLocaleString('fr-FR')} ‚Ç¨ TTC, financement sur 180 mois au TAEG fixe de ${scenario.taeg.toFixed(2)} %, mensualit√© <strong>${scenario.mensualite.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨</strong> (hors assurance).<br>
            Co√ªt total du financement hors assurance : ${scenario.total.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨.<br>
            Financement propos√© par notre partenaire Projexio, sous r√©serve d‚Äôacceptation.<br>
            <strong>Un cr√©dit vous engage et doit √™tre rembours√©. V√©rifiez vos capacit√©s de remboursement avant de vous engager.</strong>
          </span>
        </div>
      `;
      document.getElementById('resultat').style = "display:block;visibility:visible;height:auto;padding:20px;margin:0 auto 20px auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);border:1px solid #e0e0e0;";
      document.getElementById('emailBloc').style = "display:block;visibility:visible;height:auto;padding:20px;margin:0 auto 20px auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);border:1px solid #e0e0e0;";
      const bloc = document.getElementById('temoignagesBloc');
      bloc.style.display = 'block';
      bloc.style.visibility = 'visible';
      bloc.style.height = 'auto';
      afficherLienMentionsLegales();
      var telInput = document.getElementById('telUser');
      if (telInput && !telInput.hasAttribute('data-format-listener')) {
        telInput.addEventListener('input', function(e) {
          let val = e.target.value.replace(/\D/g, '').slice(0, 10);
          let format = val.replace(/(\d{2})(?=\d)/g, '$1 ').trim();
          e.target.value = format;
        });
        telInput.setAttribute('data-format-listener', '1');
      }
      // ENVOI AUTOMATIQUE VERS SHEETS (m√™me sans email)
      const formData = new FormData();
      formData.append("code_postal", codePostal);
      formData.append("conso", Math.round(conso));
      formData.append("facture", facture);
      formData.append("prod", scenario.prod);
      formData.append("eco1", economieAnnuelle.toFixed(0));
      formData.append("ecomensuelle", economieMensuelle.toFixed(0));
      formData.append("eco15", gain15ans.toFixed(0));
      formData.append("puissance", scenario.puissance);
      formData.append("panneaux", scenario.panels);
      formData.append("prix", scenario.prix);
      formData.append("mensualite", scenario.mensualite);
      formData.append("taeg", scenario.taeg);
      formData.append("totalcredit", scenario.total);
      formData.append("email", "");
      formData.append("tel", "");
      fetch('https://script.google.com/macros/s/AKfycbwhlyD_FMMm2g9JIQAm2Se2xehUqIM2MzWMl1YGl_gP1DJKM_-jZFj_YStDMhWi-0F8XA/exec', {
        method: 'POST',
        mode: 'no-cors',
        body: formData
      });
    }
    // -------- FIN DE LA CORRECTION --------

    function envoyerEstimation() {
      const codePostal = document.getElementById('codePostal').value.trim();
      const facture = parseFloat(document.getElementById('facture').value);
      const email = document.getElementById('emailUser').value.trim();
      const tel = document.getElementById('telUser').value.replace(/\D/g, '');
      const consoInput = document.getElementById('conso');
      let conso, prixKwh;
      if (!email) {
        alert("Merci de renseigner votre adresse email pour recevoir votre estimation.");
        return;
      }
      if (!selectedScenario) {
        alert("Sc√©nario non d√©fini. Veuillez d'abord lancer une simulation.");
        return;
      }
      if (consoInput && consoInput.value) {
        conso = parseFloat(consoInput.value);
        prixKwh = facture / conso;
      } else {
        prixKwh = selectedScenario.prixKwh;
        conso = facture / prixKwh;
      }
      const autoKwh = selectedScenario.prod * 0.6;
      const stockKwh = selectedScenario.prod * 0.4;
      const acheminement = 0.05;
      const factureAvant = conso * prixKwh;
      const autoValue = autoKwh * prixKwh;
      const stockValue = stockKwh * prixKwh;
      const coutAcheminement = stockKwh * acheminement;
      const factureApres = factureAvant - autoValue - stockValue + coutAcheminement;
      const economieAnnuelle = factureAvant - factureApres;
      const economieMensuelle = economieAnnuelle / 12;
      let gain15ans = 0;
      let prixActuel = prixKwh;
      for (let i = 0; i < 15; i++) {
        const autoVal = autoKwh * prixActuel;
        const stockVal = stockKwh * prixActuel;
        const coutAch = stockKwh * acheminement;
        const factureAv = conso * prixActuel;
        const factureAp = factureAv - autoVal - stockVal + coutAch;
        gain15ans += factureAv - factureAp;
        prixActuel *= 1.05;
      }
      const formData = new FormData();
      formData.append("code_postal", codePostal);
      formData.append("conso", Math.round(conso));
      formData.append("facture", facture);
      formData.append("prod", selectedScenario.prod);
      formData.append("eco1", economieAnnuelle.toFixed(0));
      formData.append("ecomensuelle", economieMensuelle.toFixed(0));
      formData.append("eco15", gain15ans.toFixed(0));
      formData.append("puissance", selectedScenario.puissance);
      formData.append("panneaux", selectedScenario.panels);
      formData.append("prix", selectedScenario.prix);
      formData.append("mensualite", selectedScenario.mensualite);
      formData.append("taeg", selectedScenario.taeg);
      formData.append("totalcredit", selectedScenario.total);
      formData.append("email", email);
      formData.append("tel", tel);
      fetch('https://script.google.com/macros/s/AKfycbwhlyD_FMMm2g9JIQAm2Se2xehUqIM2MzWMl1YGl_gP1DJKM_-jZFj_YStDMhWi-0F8XA/exec', {
        method: 'POST',
        mode: 'no-cors',
        body: formData
      });
      setTimeout(() => {
        const message = document.getElementById("confirmationMessage");
        message.style.display = "block";
        message.style.visibility = "visible"; 
        message.style.height = "auto";
        message.style.marginTop = "15px";
      }, 1000);
    }
    // Compteur dynamique
    const baseCount = 1234;
    const startDate = new Date('2025-05-01T00:00:00Z');
    function updateCompteur() {
      const now = new Date();
      const secondsElapsed = Math.floor((now - startDate) / 1000);
      const increments = Math.floor(secondsElapsed / 47);
      const total = baseCount + increments;
      const compteurElement = document.getElementById('compteurValeur');
      const current = parseInt(compteurElement.innerText.replace(/\s/g, ''), 10) || 0;
      const duration = 3000;
      const frames = 90;
      const increment = (total - current) / frames;
      let frame = 0;
      const animate = () => {
        frame++;
        const value = Math.round(current + increment * frame);
        compteurElement.innerText = value.toLocaleString('fr-FR');
        if (frame < frames) requestAnimationFrame(animate);
      };
      animate();
    }
    updateCompteur();
    setInterval(updateCompteur, 1000);
  </script>
</body>
</html>
